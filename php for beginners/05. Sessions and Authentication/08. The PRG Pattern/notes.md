# The PRG Pattern (and session flashing)
No, it's not some hip 90's r'n'b group. PRG stands for Post, Redirect, Get and is an extremely common practice when handling and validating form data. Up to this point the login form has used a `header()` to sort of fake a redirect but this introduces it's own issues that are better avoided such as duplicate form submissions and the user being lost if they attempt to use the back button after a failed validation.

## So, what to do?
The `header()` needs to be replaced with a proper redirect.

```php
return view('/sessions/create.view.php', [
    'errors' => $form->errors(),
]);

// Becomes....

redirect('/login');
```

The only issue with that is it means refreshing the page which means any errors generated by the validation are lost and the user gets no feedback as to why they aren't now logged in.

## Get on the sesh
The way around this is to use the `session` and store the errors in there instead. But this also isnt quite as straighforward as it might first appear. If the errors are stored in the session like this for example:

```php
$_SESSION['errors'] = $form->errors();
```

They can then be accessed by `Controllers/sessions/create.php`
```php
view('sessions/create.view.php', [
    'errors' => $_SESSION['errors'] ?? [],
]);
```
Which is great, right? Apart from the fact that the errors now live there until the session expires. That means for as long as this user is is in session the error will persist and always display on that page, even if the user navigates away from it. This is where `session flashing` comes in.

## Flash! Aahaaaah... ðŸŽ¤ðŸŽ¶
A first step would be to make the key even more explicit.
```php
$_SESSION['_flash']['errors'] = $form->errors();
```

The flash key also starts with an underscore. This is to avoid accidentally interfering with any other keys that might already exist under the same name and is a common approach used by frameworks and libraries. You might also sometimes see double underscores or 'dunders' as they are sometimes known.

But obviously this doesnt fix the problem. The key needs to be removed or `unset()` after it has been used.

A sensible place to do this would be after the routing has taken place in `public/index.php`. 

```php
unset($_SESSION['_flash']);
```

Now the `_flash` key will only be available the first time the login page is loaded.

## Wait, it's a trap! ðŸª¤
While this does work it also introduces a lot of opportunity for things to go wrong. For example if the `_flash` key was to be changed for any reason there are now several places where it would need to be updated to avoid breaking the code. This would be exacerbated further if the same approach was implemented for errors elsewhere across the app, which, they probably would be. This is a good indication that this functionality needs to be encapsulated to protect it from being broken in this way and that can be done (as usual) by refactoring into a class!

**Core/Session.php**
```php
namespace Core;

class session {
     // Put something in the session
    public static function put($key, $value)
    {
        $_SESSION[$key] = [$value];
    }

    // Get something from the session
    public static function get($key, $default = null)
    {
        if(isset($_SESSION['_flash'][$key])) {
            return $_SESSION['_flash'][$key];
        }
        
        return $_SESSION[$key] ?? $default;
    }

    // Query if something exists in the session
    public static function has($key)
    {
        return (bool) static::get($key);
    }

    // Add a flash key to the session
    public static function flash($key, $value)
    {
        $_SESSION['_flash'][$key] = $value;
    }

    // Destroy a flash session key
    public static function unflash()
    {
        unset($_SESSION['_flash']);
    }

    // Flush the $_SESSION superglobal
    public static function flush()
    {
        $_SESSION = [];
    }

    // Destroy the session
    public static function destroy()
    {
        static::flush();

        session_destroy();

        $params = session_get_cookie_params();
        
        setcookie('PHPSESSID', '', time() - 3600, $params['path'], $params['domain'], $params['secure'], $params['httponly']);
    }
}
```

Now, any references to `_flash` are contained within the Sessions class and the risk of this getting changed inconsistently is eliminated. Now all that needs to be done is to update the existing code where`_flash` is referenced to use the appropriate `Session` class method.